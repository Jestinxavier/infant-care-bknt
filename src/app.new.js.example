/**
 * Example app.js showing new feature-based architecture integration
 * This can be used alongside old routes during migration
 */
const express = require("express");
const cors = require("cors");
const swaggerUi = require("swagger-ui-express");
const swaggerSpec = require("./config/swagger");
const cookieParser = require("cookie-parser");
const errorMiddleware = require("./core/middleware/errorMiddleware");

const app = express();

// CORS setup
const allowedOrigins = [
  "http://localhost:3000",
  "http://localhost:3001",
  "http://localhost:5173",
  "https://infant-care.vercel.app",
  process.env.FRONTEND_URL,
  process.env.DASHBOARD_URL,
].filter(Boolean);

app.use(
  cors({
    origin: function (origin, callback) {
      if (!origin) return callback(null, true);
      if (allowedOrigins.includes(origin)) {
        callback(null, true);
      } else {
        if (process.env.NODE_ENV === "development") {
          callback(null, true);
        } else {
          callback(new Error("Not allowed by CORS"));
        }
      }
    },
    methods: ["GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"],
    credentials: true,
    allowedHeaders: [
      "Content-Type",
      "Authorization",
      "X-Requested-With",
      "x-cart-id",
      "Access-Control-Allow-Origin",
    ],
  })
);

app.use(cookieParser());
app.use(express.json());

// ============================================
// NEW FEATURE-BASED ROUTES (Modular)
// ============================================

// Product Feature
const productRoutes = require("./features/product/product.routes");
const productAdminRoutes = require("./features/product/product.admin.routes");

// CMS Feature (isolated)
const cmsAdminRoutes = require("./features/cms/cms.admin.routes");

// Admin prefix
const ADMIN_PREFIX = process.env.ADMIN_API_PREFIX || "/admin";

// Storefront routes
app.use("/api/v1/product", productRoutes);

// Admin routes
app.use(`/api/v1${ADMIN_PREFIX}/products`, productAdminRoutes);
app.use(`/api/v1${ADMIN_PREFIX}/cms`, cmsAdminRoutes);

// ============================================
// LEGACY ROUTES (During Migration)
// ============================================
// Keep these until all features are migrated
// const legacyAuthRoutes = require("./routes/auth");
// const legacyCategoryRoutes = require("./routes/categoryRoutes");
// ... etc
// app.use("/api/v1/auth", legacyAuthRoutes);

// ============================================
// GLOBAL MIDDLEWARES
// ============================================

// Swagger Documentation
app.use(
  "/api-docs",
  swaggerUi.serve,
  swaggerUi.setup(swaggerSpec, {
    customCss: ".swagger-ui .topbar { display: none }",
    customSiteTitle: "Infant Care API Docs",
  })
);

// Health check
app.get("/", (req, res) =>
  res.send(
    "API is running ðŸš€\n\nAPI Documentation: <a href='/api-docs'>/api-docs</a>"
  )
);

// ============================================
// ERROR HANDLING (Must be last)
// ============================================
app.use(errorMiddleware);

module.exports = app;

